<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Operativo 2026 | Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sb: {
                            new: '#3b82f6', // blue
                            work: '#f59e0b', // amber
                            done: '#10b981', // emerald
                            delay: '#ef4444' // red
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .gantt-row { height: 50px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; position: relative; }
        .gantt-row:hover { background-color: #f8fafc; }
        .sidebar-item { width: 250px; flex-shrink: 0; padding: 0 15px; border-right: 1px solid #e2e8f0; }
        .viewport { flex-grow: 1; overflow-x: auto; position: relative; height: 100%; }
        .timeline-header { display: flex; border-bottom: 2px solid #e2e8f0; background: white; }
        .day-cell { min-width: 40px; text-align: center; font-size: 11px; padding: 8px 0; border-right: 1px solid #f1f5f9; }
        .bar-container { position: absolute; height: 24px; display: flex; left: 0; top: 13px; }
        .bar-segment { height: 100%; cursor: pointer; transition: all 0.2s; position: relative;}
        .bar-segment:hover { opacity: 0.8; transform: scaleY(1.1); }
        .bar-segment span { position: absolute; bottom: -18px; left: 5px; font-size: 9px; color: #64748b; white-space: nowrap; }
    </style>
</head>
<body class="p-6">

<div class="max-w-[1600px] mx-auto">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-slate-900">Project <span class="text-blue-600">Gantt</span></h1>
            <p class="text-slate-500">Analisi operativa stati ticket</p>
        </div>
        <button onclick="loadData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700">
            Aggiorna Dati
        </button>
    </div>

    <div class="glass-card overflow-hidden">
        <div class="flex">
            <div class="border-r border-slate-200">
                <div class="h-10 flex items-center px-4 font-bold text-xs text-slate-500 uppercase tracking-wider">Ticket</div>
                <div id="sidebar-content"></div>
            </div>

            <div class="viewport" id="viewport">
                <div class="timeline-header" id="timeline-header"></div>
                <div id="gantt-body" class="relative"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://tdpmdloicnfqyixlxweh.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkcG1kbG9pY25mcXlpeGx4d2VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDgyODEsImV4cCI6MjA4NzU4NDI4MX0.EyPcvKFabIL_BX67S0MKLm4ccvHFr4Fiq3glt_iSJWg'; 
    const supabase = supabase.createClient(SB_URL, SB_KEY);
    const DAY_PX = 40;

    async function loadData() {
        const { data: tickets, error } = await supabase
            .from('tickets')
            .select('*')
            .order('datanuovo', { ascending: false });

        if (error) return alert("Errore Supabase");
        renderGantt(tickets);
    }

    function parseDate(d) { return d ? new Date(d) : null; }

    function renderGantt(tickets) {
        const sidebar = document.getElementById('sidebar-content');
        const header = document.getElementById('timeline-header');
        const body = document.getElementById('gantt-body');
        
        sidebar.innerHTML = ""; header.innerHTML = ""; body.innerHTML = "";

        // Calcolo Range (dal più vecchio al presente + 10 giorni)
        const allStartDates = tickets.map(t => parseDate(t.datanuovo)).filter(d => d);
        if (allStartDates.length === 0) return;
        
        const minDate = new Date(Math.min(...allStartDates));
        minDate.setDate(minDate.getDate() - 3);
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 10);
        const totalDays = Math.ceil((maxDate - minDate) / (1000*60*60*24));

        // Render Header
        for(let i=0; i<totalDays; i++) {
            const d = new Date(minDate); d.setDate(d.getDate() + i);
            const isToday = d.toDateString() === new Date().toDateString();
            header.innerHTML += `<div class="day-cell ${isToday ? 'bg-red-50 text-red-600 font-bold' : ''}">${d.getDate()}</div>`;
        }
        header.style.width = `${totalDays * DAY_PX}px`;

        // Render Rows
        tickets.forEach(t => {
            // Sidebar
            sidebar.innerHTML += `
                <div class="gantt-row sidebar-item">
                    <div class="font-bold text-sm text-slate-900">#${t.id}</div>
                    <div class="text-xs text-slate-500 truncate">${t.titolo}</div>
                </div>
            `;

            // Row Body
            const rowBody = document.createElement('div');
            rowBody.className = "gantt-row relative";
            rowBody.style.width = `${totalDays * DAY_PX}px`;

            // Calcolo segmenti barra
            const barContainer = document.createElement('div');
            barContainer.className = "bar-container";

            const segments = [
                { date: parseDate(t.datanuovo), color: 'bg-sb-new', label: 'Nuovo' },
                { date: parseDate(t.datainlavorazione), color: 'bg-sb-work', label: 'Lavoro' },
                { date: parseDate(t.datarisolto), color: 'bg-sb-done', label: 'Risolto' }
            ].filter(s => s.date);

            segments.sort((a,b) => a.date - b.date);

            for(let i=0; i<segments.length; i++) {
                const segStart = segments[i].date;
                const segEnd = (i < segments.length -1) ? segments[i+1].date : new Date();
                
                // Se il ticket è chiuso, la barra finisce alla data di chiusura
                const finalEnd = (t.datachiuso && parseDate(t.datachiuso) < segEnd) ? parseDate(t.datachiuso) : segEnd;
                
                const duration = Math.max(1, Math.ceil((finalEnd - segStart) / (1000*60*60*24)));
                const left = Math.floor((segStart - minDate) / (1000*60*60*24)) * DAY_PX;

                barContainer.innerHTML += `
                    <div class="bar-segment ${segments[i].color}" 
                         style="width: ${duration * DAY_PX}px; left: ${left}px;"
                         title="${segments[i].label}: ${segStart.toLocaleDateString()}">
                        <span>${segments[i].label}</span>
                    </div>
                `;
            }

            rowBody.appendChild(barContainer);
            body.appendChild(rowBody);
        });
    }

    loadData();
</script>
</body>
</html>
