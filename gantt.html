<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Gantt Operativo Ticket | 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f4f8; }
        .gantt-container { overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .row-height { height: 48px; }
        .bar { position: absolute; height: 24px; top: 12px; border-radius: 12px; }
        .bar-label { font-size: 10px; color: white; padding: 4px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .no-data-bar { background-color: #cbd5e1; height: 24px; border-radius: 12px; display: flex; align-items: center; padding: 0 10px; font-size: 12px; color: #475569; }
        .timeline-cell { min-width: 40px; text-align: center; font-size: 10px; color: #64748b; border-right: 1px solid #e2e8f0; padding: 8px 0; }
        .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(239, 68, 68, 0.7); z-index: 10; }
    </style>
</head>
<body class="p-4 md:p-6">

<div class="max-w-[1800px] mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-slate-950">Pianificazione Gantt <span class="text-blue-600">Ticket</span></h1>
        <button onclick="loadGantt()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
            Aggiorna
        </button>
    </div>

    <div class="gantt-container" id="gantt-viewport">
        <div id="timeline-header" class="flex border-b border-slate-200 bg-slate-50 sticky top-0 z-20"></div>
        <div id="gantt-content" class="relative"></div>
    </div>
</div>

<script>
    // --- CONFIGURA SUPABASE QUI ---
    const SB_URL = ' https://tdpmdloicnfqyixlxweh.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkcG1kbG9pY25mcXlpeGx4d2VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDgyODEsImV4cCI6MjA4NzU4NDI4MX0.EyPcvKFabIL_BX67S0MKLm4ccvHFr4Fiq3glt_iSJWg';
    // -----------------------------
    
    // Dichiarazione singola
    const client = supabase.createClient(SB_URL, SB_KEY);
    const DAY_PX = 40; 

    async function loadGantt() {
        const content = document.getElementById('gantt-content');
        const header = document.getElementById('timeline-header');
        content.innerHTML = '<div class="p-4">Caricamento...</div>';
        header.innerHTML = '';

        // Uso del client dichiarato sopra
        const { data: tickets, error } = await client
            .from('tickets') 
            .select('*');

        if (error) {
            content.innerHTML = `<div class="p-4 text-red-500">Errore: ${error.message}</div>`;
            return;
        }

        render(tickets);
    }

    function render(tickets) {
        const header = document.getElementById('timeline-header');
        const content = document.getElementById('gantt-content');
        content.innerHTML = '';

        if (tickets.length === 0) {
            content.innerHTML = '<div class="p-4">Nessun ticket trovato.</div>';
            return;
        }

        const allDates = [];
        tickets.forEach(t => {
            if(t.datainizioprevista) allDates.push(new Date(t.datainizioprevista));
            if(t.datainserimento) allDates.push(new Date(t.datainserimento));
        });
        
        if (allDates.length === 0) allDates.push(new Date());
        
        const minDate = new Date(Math.min(...allDates));
        minDate.setDate(minDate.getDate() - 2);
        
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 30);
        const totalDays = Math.ceil((maxDate - minDate) / (1000*60*60*24));

        let timelineHtml = `<div style="min-width: 250px" class="border-r border-slate-200"></div>`;
        for (let i = 0; i < totalDays; i++) {
            let d = new Date(minDate);
            d.setDate(d.getDate() + i);
            timelineHtml += `<div class="timeline-cell">${d.getDate()}/${d.getMonth()+1}</div>`;
        }
        header.innerHTML = timelineHtml;
        header.style.width = `${250 + (totalDays * DAY_PX)}px`;

        tickets.forEach(t => {
            const row = document.createElement('div');
            row.className = "flex border-b border-slate-100 row-height relative";
            row.style.width = `${250 + (totalDays * DAY_PX)}px`;

            row.innerHTML = `
                <div style="min-width: 250px" class="flex items-center px-4 border-r border-slate-100 bg-white z-10 sticky left-0">
                    <div>
                        <div class="font-bold text-sm text-slate-900">#${t.id} - ${t.titolo || 'Senza Titolo'}</div>
                        <div class="text-xs text-slate-500">${t.stato || 'Nuovo'}</div>
                    </div>
                </div>
                <div class="flex-grow relative" id="row-bar-${t.id}"></div>
            `;
            content.appendChild(row);

            const barContainer = document.getElementById(`row-bar-${t.id}`);
            
            if (t.datainizioprevista && t.datafineprevista) {
                const start = new Date(t.datainizioprevista);
                const end = new Date(t.datafineprevista);
                const startOffset = Math.floor((start - minDate) / (1000*60*60*24));
                const duration = Math.ceil((end - start) / (1000*60*60*24));
                
                let bgColor = "bg-blue-500";
                if (t.stato === "Completato") bgColor = "bg-emerald-500";
                if (new Date() > end && t.stato !== "Completato") bgColor = "bg-red-500";

                barContainer.innerHTML = `
                    <div class="bar ${bgColor}" style="left: ${startOffset * DAY_PX}px; width: ${duration * DAY_PX}px;">
                        <div class="bar-label">${t.titolo || 'Ticket'}</div>
                    </div>
                `;
            } else {
                barContainer.innerHTML = `
                    <div class="absolute inset-0 flex items-center p-2">
                        <div class="no-data-bar">Nessuna pianificazione</div>
                    </div>
                `;
            }
        });

        const todayOffset = Math.floor((new Date() - minDate) / (1000*60*60*24));
        const todayLine = document.createElement('div');
        todayLine.className = "today-line";
        todayLine.style.left = `${250 + (todayOffset * DAY_PX)}px`;
        content.appendChild(todayLine);
    }

    loadGantt();
</script>
</body>
</html>
