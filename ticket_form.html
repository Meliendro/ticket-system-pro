<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Ticket</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family:'Segoe UI', sans-serif; background: linear-gradient(135deg,#1e293b,#0f172a); min-height:100vh; }
.form-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding:2rem; border-radius:1.5rem; max-width:600px; margin:auto; }
input, select, textarea { width:100%; padding:0.5rem; border-radius:0.5rem; border:1px solid #d1d5db; margin-bottom:0.8rem; }
label { font-weight:600; font-size:0.75rem; color:#374151; text-transform:uppercase; margin-bottom:0.2rem; display:block;}
.original-date { font-size:0.75rem; color:#6b7280; margin-top:-0.5rem; margin-bottom:0.8rem;}
.edit-date-btn { background:#2563eb; color:white; padding:2px 6px; border-radius:4px; font-size:0.75rem; cursor:pointer; margin-bottom:0.5rem;}
</style>
</head>
<body class="p-6">

<div class="form-card">
<h1 id="formTitle" class="text-xl font-bold mb-4">Nuovo Ticket</h1>

<label>Titolo</label>
<input type="text" id="titolo">

<label>Descrizione</label>
<textarea id="descrizione" rows="4"></textarea>

<label>Data Inserimento</label>
<div class="flex items-center gap-2">
<input type="date" id="dataInserimento" disabled>
<button type="button" id="editDateBtn" class="edit-date-btn">Modifica</button>
</div>
<span id="originalData" class="original-date"></span>

<label>Stato</label>
<select id="stato">
  <option value="Nuovo">Nuovo</option>
  <option value="In lavorazione">In lavorazione</option>
  <option value="Completato">Completato</option>
</select>

<button onclick="saveTicket()" class="bg-green-600 text-white px-4 py-2 rounded mt-2">Salva</button>
</div>

<script>
// ðŸ”‘ Inserisci qui i tuoi dati Supabase
const supabaseUrl = "https://tdpmdloicnfqyixlxweh.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkcG1kbG9pY25mcXlpeGx4d2VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDgyODEsImV4cCI6MjA4NzU4NDI4MX0.EyPcvKFabIL_BX67S0MKLm4ccvHFr4Fiq3glt_iSJWg";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// Broadcast channel per aggiornare index.html
const ticketChannel = new BroadcastChannel('ticket_ytable');

// Controllo se apriamo in modifica
const params = new URLSearchParams(window.location.search);
const nrTicketMod = params.get("nr");

let originalData = new Date().toISOString().split('T')[0];
document.getElementById('dataInserimento').value = originalData;
document.getElementById('originalData').innerText = "(Orig: "+originalData+")";

if(nrTicketMod){
    loadTicket(nrTicketMod);
}

// Rende modificabile la data inserimento
document.getElementById('editDateBtn').addEventListener('click',()=> {
    document.getElementById('dataInserimento').disabled=false;
});

// Carica ticket esistente
async function loadTicket(nr){
    const { data, error } = await supabase
        .from('tickets')
        .select('*')
        .eq('nr_ticket', nr)
        .single();
    if(error){ alert(error.message); return; }
    document.getElementById('titolo').value = data.titolo;
    document.getElementById('descrizione').value = data.descrizione;
    document.getElementById('stato').value = data.stato;
    document.getElementById('dataInserimento').value = data.data_inserimento;
    originalData = data.data_inserimento;
    document.getElementById('originalData').innerText="(Orig: "+originalData+")";
    document.getElementById('formTitle').innerText="Modifica Ticket #"+nr;
}

// Salva ticket
async function saveTicket(){
    let titolo = document.getElementById('titolo').value;
    let descr = document.getElementById('descrizione').value;
    let stato = document.getElementById('stato').value;
    let dataIns = document.getElementById('dataInserimento').value;

    if(!titolo){ alert("Inserisci titolo"); return; }

    if(nrTicketMod){
        await supabase.from('tickets').update({
            titolo:titolo, descrizione:descr, stato:stato, data_inserimento:dataIns
        }).eq('nr_ticket', nrTicketMod);
    } else {
        const { data: maxTicket } = await supabase
            .from('tickets')
            .select('nr_ticket')
            .order('nr_ticket',{ascending:false})
            .limit(1);
        const newNr = maxTicket.length ? maxTicket[0].nr_ticket+1 : 1;
        await supabase.from('tickets').insert({
            nr_ticket:newNr, titolo:titolo, descrizione:descr, stato:stato, data_inserimento:dataIns
        });
    }

    ticketChannel.postMessage({ action:'reload' });
    window.close();
}
</script>

</body>
</html>
