<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ticket - Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 30px; background-color: #f4f7f6; }
        .container { max-width: 500px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: auto; }
        h2 { color: #333; margin-top: 0; }
        label { font-weight: bold; display: block; margin-top: 15px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 100px; resize: vertical; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-save { background-color: #27ae60; color: white; }
        .btn-cancel { background-color: #95a5a6; color: white; }
        #messaggio { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; border: 1px solid #721c24; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="titolo-pagina">Caricamento...</h2>
    <div id="messaggio"></div>

    <form id="form-ticket">
        <input type="hidden" id="ticket-id">
        
        <label for="titolo">Oggetto / Nome</label>
        <input type="text" id="titolo" placeholder="Inserisci il titolo del ticket" required>
        
        <label for="descrizione">Descrizione</label>
        <textarea id="descrizione" placeholder="Dettagli del problema..."></textarea>
        
        <label for="tipo-select">Tipo</label>
        <select id="tipo-select" required>
            <option value="">Caricamento tipi...</option>
        </select>

        <label for="priorita-select">Priorità</label>
        <select id="priorita-select" required>
            <option value="">Caricamento priorità...</option>
        </select>

        <label for="ambito-select">Ambito</label>
        <select id="ambito-select" required>
            <option value="">Caricamento ambiti...</option>
        </select>

        <label for="stato-select">Stato</label>
        <select id="stato-select" required>
            <option value="">Caricamento stati...</option>
        </select>
        
        <div class="btn-group">
            <button type="submit" class="btn-save">Salva Ticket</button>
            <button type="button" class="btn-cancel" onclick="location.href='index.html'">Annulla</button>
        </div>
    </form>
</div>

<script>
    const SB_URL = 'https://tdpmdloicnfqyixlxweh.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkcG1kbG9pY25mcXlpeGx4d2VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDgyODEsImV4cCI6MjA4NzU4NDI4MX0.EyPcvKFabIL_BX67S0MKLm4ccvHFr4Fiq3glt_iSJWg';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id');

    document.getElementById('titolo-pagina').innerText = editId ? "Modifica Ticket #" + editId : "Nuovo Ticket";

    async function inizializza() {
        try {
            // Carichiamo STATI, TIPI, PRIORITA e AMBITI contemporaneamente
            const [resStati, resTipi, resPriorita, resAmbiti] = await Promise.all([
                _supabase.from('stato').select('stato'),
                _supabase.from('tipo').select('tipo'),
                _supabase.from('priorita').select('priorita'),
                _supabase.from('ambito').select('ambito')
            ]);

            // Popolamento STATO
            const selectStato = document.getElementById('stato-select');
            if (resStati.error) throw resStati.error;
            selectStato.innerHTML = resStati.data && resStati.data.length > 0 
                ? '<option value="">-- Seleziona Stato --</option>' + resStati.data.map(i => `<option value="${i.stato}">${i.stato}</option>`).join('')
                : '<option value="">Nessun dato in tabella "stato"</option>';

            // Popolamento TIPO
            const selectTipo = document.getElementById('tipo-select');
            if (resTipi.error) throw resTipi.error;
            selectTipo.innerHTML = resTipi.data && resTipi.data.length > 0 
                ? '<option value="">-- Seleziona Tipo --</option>' + resTipi.data.map(i => `<option value="${i.tipo}">${i.tipo}</option>`).join('')
                : '<option value="">Nessun dato in tabella "tipo"</option>';

            // Popolamento PRIORITA
            const selectPriorita = document.getElementById('priorita-select');
            if (resPriorita.error) throw resPriorita.error;
            selectPriorita.innerHTML = resPriorita.data && resPriorita.data.length > 0 
                ? '<option value="">-- Seleziona Priorità --</option>' + resPriorita.data.map(i => `<option value="${i.priorita}">${i.priorita}</option>`).join('')
                : '<option value="">Nessun dato in tabella "priorita"</option>';

            // Popolamento AMBITO
            const selectAmbito = document.getElementById('ambito-select');
            if (resAmbiti.error) throw resAmbiti.error;
            selectAmbito.innerHTML = resAmbiti.data && resAmbiti.data.length > 0 
                ? '<option value="">-- Seleziona Ambito --</option>' + resAmbiti.data.map(i => `<option value="${i.ambito}">${i.ambito}</option>`).join('')
                : '<option value="">Nessun dato in tabella "ambito"</option>';

            // Se siamo in modifica, carichiamo i dati del ticket
            if (editId) {
                await caricaDatiTicket(editId);
            }
        } catch (err) {
            console.error("Errore Inizializzazione:", err);
            mostraErrore("Errore caricamento tabelle: " + err.message);
        }
    }

    async function caricaDatiTicket(id) {
        const { data, error } = await _supabase.from('tickets').select('*').eq('id', id).single();
        if (error) {
            mostraErrore("Errore caricamento ticket: " + error.message);
        } else if (data) {
            document.getElementById('ticket-id').value = data.id;
            document.getElementById('titolo').value = data.titolo || '';
            document.getElementById('descrizione').value = data.descrizione || '';
            document.getElementById('stato-select').value = data.stato || '';
            document.getElementById('tipo-select').value = data.tipo || '';
            document.getElementById('priorita-select').value = data.priorita || '';
            document.getElementById('ambito-select').value = data.ambito || '';
        }
    }

    document.getElementById('form-ticket').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('ticket-id').value;
        const payload = {
            titolo: document.getElementById('titolo').value,
            descrizione: document.getElementById('descrizione').value,
            stato: document.getElementById('stato-select').value,
            tipo: document.getElementById('tipo-select').value,
            priorita: document.getElementById('priorita-select').value,
            ambito: document.getElementById('ambito-select').value
        };

        try {
            let res = id ? await _supabase.from('tickets').update(payload).eq('id', id) : await _supabase.from('tickets').insert([payload]);
            if (res.error) throw res.error;
            location.href = 'index.html';
        } catch (err) {
            mostraErrore("Errore salvataggio: " + err.message);
        }
    });

    function mostraErrore(testo) {
        const box = document.getElementById('messaggio');
        box.style.display = 'block';
        box.style.backgroundColor = '#f8d7da';
        box.style.color = '#721c24';
        box.innerText = testo;
    }

    inizializza();
</script>
</body>
</html>
