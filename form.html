<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ticket - Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 30px; background-color: #f4f7f6; }
        .container { max-width: 500px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: auto; }
        h2 { color: #333; margin-top: 0; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 100px; resize: vertical; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-save { background-color: #27ae60; color: white; }
        .btn-cancel { background-color: #95a5a6; color: white; }
        #messaggio { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="titolo-pagina">Nuovo Ticket</h2>
    <div id="messaggio"></div>

    <form id="form-ticket">
        <input type="hidden" id="ticket-id">
        
        <label for="titolo">Oggetto / Nome</label>
        <input type="text" id="titolo" placeholder="Inserisci il titolo del ticket" required>
        
        <label for="descrizione">Descrizione</label>
        <textarea id="descrizione" placeholder="Dettagli del problema..."></textarea>
        
        <label for="stato">Stato</label>
        <select id="stato" required>
            <option value="">Caricamento stati...</option>
        </select>
        
        <div class="btn-group">
            <button type="submit" class="btn-save">Salva Ticket</button>
            <button type="button" class="btn-cancel" onclick="location.href='index.html'">Annulla</button>
        </div>
    </form>
</div>

<script>
    const SB_URL = 'https://tdpmdloicnfqyixlxweh.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkcG1kbG9pY25mcXlpeGx4d2VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDgyODEsImV4cCI6MjA4NzU4NDI4MX0.EyPcvKFabIL_BX67S0MKLm4ccvHFr4Fiq3glt_iSJWg';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id');

    // Funzione per caricare gli stati dalla tabella "stato"
    async function caricaStati() {
        const { data, error } = await _supabase
            .from('stato') // Legge dalla tabella stato
            .select('*');

        const selectStato = document.getElementById('stato');
        
        if (error) {
            console.error("Errore caricamento stati:", error);
            selectStato.innerHTML = '<option value="">Errore caricamento</option>';
            return;
        }

        // Popola la tendina. Assumo che la colonna si chiami 'nome' o 'valore'
        // Se la colonna ha un altro nome (es. 'descrizione'), cambialo qui sotto
        selectStato.innerHTML = '<option value="">-- Seleziona Stato --</option>' + 
            data.map(s => `<option value="${s.nome}">${s.nome}</option>`).join('');

        // Se siamo in modifica, dopo aver caricato gli stati, selezioniamo quello giusto
        if (editId) {
            caricaDatiEsistenti(editId);
        }
    }

    async function caricaDatiEsistenti(id) {
        const { data, error } = await _supabase
            .from('tickets')
            .select('*')
            .eq('id', id)
            .single();

        if (error) {
            mostraErrore("Errore nel caricamento: " + error.message);
        } else if (data) {
            document.getElementById('ticket-id').value = data.id;
            document.getElementById('titolo').value = data.titolo || '';
            document.getElementById('descrizione').value = data.descrizione || '';
            // Imposta il valore della select
            document.getElementById('stato').value = data.stato || '';
        }
    }

    document.getElementById('form-ticket').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('ticket-id').value;
        const titolo = document.getElementById('titolo').value;
        const descrizione = document.getElementById('descrizione').value;
        const stato = document.getElementById('stato').value;

        const payload = { titolo, descrizione, stato };
        let risultato;

        try {
            if (id) {
                risultato = await _supabase.from('tickets').update(payload).eq('id', id);
            } else {
                risultato = await _supabase.from('tickets').insert([payload]);
            }

            if (risultato.error) throw risultato.error;
            location.href = 'index.html';

        } catch (err) {
            mostraErrore("Errore nel salvataggio: " + err.message);
        }
    });

    function mostraErrore(testo) {
        const box = document.getElementById('messaggio');
        box.style.display = 'block';
        box.style.backgroundColor = '#f8d7da';
        box.style.color = '#721c24';
        box.innerText = testo;
    }

    // Avvio: prima carichiamo gli stati
    caricaStati();
</script>

</body>
</html>
