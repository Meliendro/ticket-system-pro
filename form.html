<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ticket - Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 30px; background-color: #f4f7f6; }
        .container { max-width: 600px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: auto; }
        h2 { color: #333; margin-top: 0; }
        
        fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; background-color: #fafafa; }
        legend { font-weight: bold; color: #2c3e50; padding: 0 10px; }
        
        label { font-weight: bold; display: block; margin-top: 10px; font-size: 0.9rem; }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        
        /* Stile per la riga bloccante */
        .bloccante-row { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .bloccante-row select { width: 100px; margin: 0; }
        #status-label { font-weight: bold; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; }
        .is-bloccante { background-color: #e74c3c; color: white; }
        .not-bloccante { background-color: #bdc3c7; color: #333; }
        
        textarea { height: 80px; resize: vertical; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-save { background-color: #27ae60; color: white; }
        .btn-cancel { background-color: #95a5a6; color: white; }
        #messaggio { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; border: 1px solid #721c24; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="titolo-pagina">Caricamento...</h2>
    <div id="messaggio"></div>

    <form id="form-ticket">
        <input type="hidden" id="ticket-id">
        
        <label for="titolo">Oggetto / Nome</label>
        <input type="text" id="titolo" placeholder="Inserisci il titolo del ticket" required>
        
        <label for="descrizione">Descrizione</label>
        <textarea id="descrizione" placeholder="Dettagli del problema..."></textarea>
        
        <fieldset>
            <legend>Classificazione e Stato</legend>
            
            <label for="stato-select">Stato</label>
            <select id="stato-select" required>
                <option value="">Caricamento stati...</option>
            </select>

            <label for="priorita-select">Priorità</label>
            <select id="priorita-select" required>
                <option value="">Caricamento priorità...</option>
            </select>

            <label for="tipo-select">Tipo</label>
            <select id="tipo-select" required>
                <option value="">Caricamento tipi...</option>
            </select>

            <label for="ambito-select">Ambito</label>
            <select id="ambito-select" required>
                <option value="">Caricamento ambiti...</option>
            </select>

            <label for="menu-select">Menu</label>
            <select id="menu-select" required>
                <option value="">Caricamento menu...</option>
            </select>

            <label>Bloccante?</label>
            <div class="bloccante-row">
                <select id="bloccante-select" onchange="aggiornaEtichettaBloccante()">
                    <option value="false">No</option>
                    <option value="true">Sì</option>
                </select>
                <span id="status-label" class="not-bloccante">NON BLOCCANTE</span>
            </div>
        </fieldset>
        
        <div class="btn-group">
            <button type="submit" class="btn-save">Salva Ticket</button>
            <button type="button" class="btn-cancel" onclick="location.href='index.html'">Annulla</button>
        </div>
    </form>
</div>

<script>
    const SB_URL = 'https://tdpmdloicnfqyixlxweh.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkcG1kbG9pY25mcXlpeGx4d2VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDgyODEsImV4cCI6MjA4NzU4NDI4MX0.EyPcvKFabIL_BX67S0MKLm4ccvHFr4Fiq3glt_iSJWg';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id');

    document.getElementById('titolo-pagina').innerText = editId ? "Modifica Ticket #" + editId : "Nuovo Ticket";

    // Gestione grafica dell'etichetta bloccante
    function aggiornaEtichettaBloccante() {
        const select = document.getElementById('bloccante-select');
        const label = document.getElementById('status-label');
        if (select.value === "true") {
            label.innerText = "BLOCCANTE";
            label.className = "is-bloccante";
        } else {
            label.innerText = "NON BLOCCANTE";
            label.className = "not-bloccante";
        }
    }

    async function inizializza() {
        try {
            const [resStati, resTipi, resPriorita, resAmbiti, resMenu] = await Promise.all([
                _supabase.from('stato').select('stato'),
                _supabase.from('tipo').select('tipo'),
                _supabase.from('priorita').select('priorita'),
                _supabase.from('ambito').select('ambito'),
                _supabase.from('menu').select('menu')
            ]);

            popolaSelect('stato-select', resStati, 'stato', '-- Seleziona Stato --');
            popolaSelect('tipo-select', resTipi, 'tipo', '-- Seleziona Tipo --');
            popolaSelect('priorita-select', resPriorita, 'priorita', '-- Seleziona Priorità --');
            popolaSelect('ambito-select', resAmbiti, 'ambito', '-- Seleziona Ambito --');
            popolaSelect('menu-select', resMenu, 'menu', '-- Seleziona Menu --');

            if (editId) {
                await caricaDatiTicket(editId);
            }
        } catch (err) {
            console.error("Errore Inizializzazione:", err);
            mostraErrore("Errore caricamento tabelle: " + err.message);
        }
    }

    function popolaSelect(id, response, column, defaultText) {
        const select = document.getElementById(id);
        if (response.error) {
            select.innerHTML = `<option value="">Errore: ${response.error.message}</option>`;
            return;
        }
        if (response.data && response.data.length > 0) {
            select.innerHTML = `<option value="">${defaultText}</option>` + 
                response.data.map(i => `<option value="${i[column]}">${i[column]}</option>`).join('');
        } else {
            select.innerHTML = `<option value="">Nessun dato trovato</option>`;
        }
    }

    async function caricaDatiTicket(id) {
        const { data, error } = await _supabase.from('tickets').select('*').eq('id', id).single();
        if (error) {
            mostraErrore("Errore caricamento ticket: " + error.message);
        } else if (data) {
            document.getElementById('ticket-id').value = data.id;
            document.getElementById('titolo').value = data.titolo || '';
            document.getElementById('descrizione').value = data.descrizione || '';
            document.getElementById('stato-select').value = data.stato || '';
            document.getElementById('tipo-select').value = data.tipo || '';
            document.getElementById('priorita-select').value = data.priorita || '';
            document.getElementById('ambito-select').value = data.ambito || '';
            document.getElementById('menu-select').value = data.menu || '';
            
            // Gestione booleano per la tendina bloccante
            const isBloccante = data.bloccante === true || data.bloccante === "true";
            document.getElementById('bloccante-select').value = isBloccante.toString();
            aggiornaEtichettaBloccante();
        }
    }

    document.getElementById('form-ticket').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('ticket-id').value;
        
        // Convertiamo la stringa della select in un vero valore booleano
        const bloccanteValue = document.getElementById('bloccante-select').value === "true";

        const payload = {
            titolo: document.getElementById('titolo').value,
            descrizione: document.getElementById('descrizione').value,
            stato: document.getElementById('stato-select').value,
            tipo: document.getElementById('tipo-select').value,
            priorita: document.getElementById('priorita-select').value,
            ambito: document.getElementById('ambito-select').value,
            menu: document.getElementById('menu-select').value,
            bloccante: bloccanteValue
        };

        try {
            let res = id ? await _supabase.from('tickets').update(payload).eq('id', id) : await _supabase.from('tickets').insert([payload]);
            if (res.error) throw res.error;
            location.href = 'index.html';
        } catch (err) {
            mostraErrore("Errore salvataggio: " + err.message);
        }
    });

    function mostraErrore(testo) {
        const box = document.getElementById('messaggio');
        box.style.display = 'block';
        box.style.backgroundColor = '#f8d7da';
        box.style.color = '#721c24';
        box.innerText = testo;
    }

    inizializza();
</script>
</body>
</html>
