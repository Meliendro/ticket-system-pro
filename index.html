<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket System Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-900 text-white p-10">
  
<div id="authSection" class="mb-6">
  <input id="email" placeholder="Email" class="p-2 text-black rounded">
  <input id="password" type="password" placeholder="Password" class="p-2 text-black rounded">
  <button onclick="login()" class="bg-blue-600 px-4 py-2 rounded ml-2">Login</button>
  <button onclick="register()" class="bg-gray-600 px-4 py-2 rounded ml-2">Register</button>
</div>
  
<h1 class="text-3xl font-bold mb-6">Ticket System Pro</h1>

<div class="mb-4">
  <input id="titolo" placeholder="Titolo" class="p-2 text-black rounded w-64">
  <button onclick="saveTicket()" class="bg-green-600 px-4 py-2 rounded ml-2">
    Salva
  </button>
</div>
  
<div class="grid grid-cols-3 gap-4 mb-6">
  <div class="bg-blue-600 p-4 rounded" id="countNuovi"></div>
  <div class="bg-yellow-600 p-4 rounded" id="countInLavorazione"></div>
  <div class="bg-green-600 p-4 rounded" id="countCompletati"></div>
</div>
  
<div id="ticketList"></div>

<script>
const supabaseUrl = "https://lfwhgkscrhsnpfkoehik.supabase.co";
const supabaseKey = "sb_publishable_J8nVFzeAYSCdOzhEQich0w_jLO9ur-r";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Funzione per registrazione
async function register() {
  const { error } = await supabase.auth.signUp({
    email: document.getElementById('email').value,
    password: document.getElementById('password').value
  });
  if(error) alert(error.message);
  else alert("Registrazione completata");
}

// Funzione per login
async function login() {
  const { data, error } = await supabase.auth.signInWithPassword({
    email: document.getElementById('email').value,
    password: document.getElementById('password').value
  });
  if(error) alert(error.message);
  else {
    document.getElementById('authSection').style.display="none";
    loadTickets();
  }
}

// Controlla sessione attiva all'apertura
(async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if(session) {
    document.getElementById('authSection').style.display="none";
    loadTickets();
  }
})();

// Salvataggio ticket
async function saveTicket() {
  const { data: maxTicket } = await supabase
    .from('tickets')
    .select('nr_ticket')
    .order('nr_ticket', { ascending: false })
    .limit(1);

  const newNumber = maxTicket.length ? maxTicket[0].nr_ticket + 1 : 1;

  await supabase.from('tickets').insert({
    nr_ticket: newNumber,
    titolo: document.getElementById('titolo').value,
    stato: "Nuovo",
    data_inserimento: new Date().toISOString().split('T')[0]
  });

  loadTickets();
}

// Caricamento ticket e conteggi
async function loadTickets() {
  const { data } = await supabase
    .from('tickets')
    .select('*')
    .order('nr_ticket', { ascending: true });

  document.getElementById('ticketList').innerHTML =
    data.map(t => `<div class="border p-2 my-2">
      #${t.nr_ticket} - ${t.titolo} (${t.stato})
    </div>`).join('');

  document.getElementById('countNuovi').innerHTML = "Nuovi: " + data.filter(t => t.stato === "Nuovo").length;
  document.getElementById('countInLavorazione').innerHTML = "In lavorazione: " + data.filter(t => t.stato === "In lavorazione").length;
  document.getElementById('countCompletati').innerHTML = "Completati: " + data.filter(t => t.stato === "Completato").length;
}

// Sottoscrizione live
supabase
  .channel('tickets')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, () => {
    loadTickets();
  })
  .subscribe();

</script>

</body>
</html>
