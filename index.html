<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket System Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family:'Segoe UI', sans-serif; background:#f4f4f5; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
.ticket-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding:1rem; border-radius:1rem; margin-bottom:0.5rem; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
button { transition: all 0.2s ease; }
button:hover { transform: scale(1.03);}
</style>
</head>
<body class="p-6">

<header>
  <h1 class="text-3xl font-bold text-slate-800">Ticket System Pro</h1>
  <div>
    <button onclick="newTicket()" class="bg-blue-600 text-white px-4 py-2 rounded">Nuovo Ticket</button>
  </div>
</header>

<div id="ticketList" class="space-y-2"></div>

<script>
// ðŸ”‘ Inserisci qui i tuoi dati Supabase
const supabaseUrl = "https://tdpmdloicnfqyixlxweh.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkcG1kbG9pY25mcXlpeGx4d2VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDgyODEsImV4cCI6MjA4NzU4NDI4MX0.EyPcvKFabIL_BX67S0MKLm4ccvHFr4Fiq3glt_iSJWg";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// Broadcast channel per ricevere aggiornamenti dal form
const ticketChannel = new BroadcastChannel('ticket_ytable');
ticketChannel.onmessage = (msg) => {
    console.log("Messaggio ricevuto dal form:", msg.data);
    if(msg.data?.action === 'reload') loadTickets();
};

// Nuovo ticket
function newTicket(){
    const win = window.open("ticket_form.html","_blank","width=800,height=900");
    if(!win) alert("Impossibile aprire il form: controlla il popup blocker o apri tramite server locale");
}

// Edit ticket
function editTicket(nr){
    const win = window.open("ticket_form.html?nr="+nr,"_blank","width=800,height=900");
    if(!win) alert("Impossibile aprire il form: controlla il popup blocker o apri tramite server locale");
}

// Carica i ticket
async function loadTickets(){
    try {
        const { data, error } = await supabase
            .from('tickets')
            .select('*')
            .order('nr_ticket',{ascending:true});
        if(error){ alert("Errore caricamento: "+error.message); return; }

        const container = document.getElementById('ticketList');
        container.innerHTML = "";
        if(!data.length) container.innerHTML = "<p>Nessun ticket presente</p>";

        data.forEach(t => {
            const div = document.createElement('div');
            div.className = "ticket-card";
            div.innerHTML = `
                <b>#${t.nr_ticket}</b> - ${t.titolo || "(nessun titolo)"} <br>
                Stato: ${t.stato || "(nessuno)"} <br>
                Data Inserimento: ${t.data_inserimento || "(nessuna)"} <br>
                <button onclick="editTicket(${t.nr_ticket})" class="bg-yellow-400 text-black px-3 py-1 rounded mt-1">Modifica</button>
            `;
            container.appendChild(div);
        });

        console.log(`Caricati ${data.length} ticket`);
    } catch(e){
        alert("Errore generico caricamento ticket: " + e.message);
        console.error(e);
    }
}

// Ricarica iniziale
loadTickets();
</script>

</body>
</html>
